import{u as k,q as L,P as G,G as H,j as R}from"./index-DNuGHCz-.js";import{g as b,M as X,a as M,n as j,o as z,C as K,q as V,r as Q,m as U,u as _,v as J,f as Y,i as Z,w as W,x as ee,G as te,S as ne,y as re,z as oe,A as T,P as le,N as ie}from"./index-4xP957cW.js";import"./index-DgNYeu8w.js";import"./MdCatalog-CEBMa-Sf.js";const N=_({commentTokens:{block:{open:"<!--",close:"-->"}}}),D=new ie,q=J.configure({props:[Y.add(t=>!t.is("Block")||t.is("Document")||y(t)!=null?void 0:(i,r)=>({from:r.doc.lineAt(i.from).to,to:i.to})),D.add(y),Z.add({Document:()=>null}),W.add({Document:N})]});function y(t){let i=/^(?:ATX|Setext)Heading(\d)$/.exec(t.name);return i?+i[1]:void 0}function se(t,i){let r=t;for(;;){let e=r.nextSibling,n;if(!e||(n=y(e.type))!=null&&n<=i)break;r=e}return r.to}const ae=ee.of((t,i,r)=>{for(let e=b(t).resolveInner(r,-1);e&&!(e.from<i);e=e.parent){let n=e.type.prop(D);if(n==null)continue;let s=se(e,n);if(s>r)return{from:r,to:s}}return null});function I(t){return new V(N,t,[ae],"markdown")}const fe=I(q),me=q.configure([te,ne,re,oe]),F=I(me);function ue(t,i){return r=>{if(r&&t){let e=null;if(r=/\S*/.exec(r)[0],typeof t=="function"?e=t(r):e=T.matchLanguageName(t,r,!0),e instanceof T)return e.support?e.support.language.parser:le.getSkippingParser(e.load());if(e)return e.parser}return i?i.parser:null}}class C{constructor(i,r,e,n,s,a,m){this.node=i,this.from=r,this.to=e,this.spaceBefore=n,this.spaceAfter=s,this.type=a,this.item=m}blank(i,r=!0){let e=this.spaceBefore+(this.node.name=="Blockquote"?">":"");if(i!=null){for(;e.length<i;)e+=" ";return e}else{for(let n=this.to-this.from-e.length-this.spaceAfter.length;n>0;n--)e+=" ";return e+(r?this.spaceAfter:"")}}marker(i,r){let e=this.node.name=="OrderedList"?String(+$(this.item,i)[2]+r):"";return this.spaceBefore+e+this.type+this.spaceAfter}}function O(t,i){let r=[];for(let n=t;n&&n.name!="Document";n=n.parent)(n.name=="ListItem"||n.name=="Blockquote"||n.name=="FencedCode")&&r.push(n);let e=[];for(let n=r.length-1;n>=0;n--){let s=r[n],a,m=i.lineAt(s.from),o=s.from-m.from;if(s.name=="FencedCode")e.push(new C(s,o,o,"","","",null));else if(s.name=="Blockquote"&&(a=/^ *>( ?)/.exec(m.text.slice(o))))e.push(new C(s,o,o+a[0].length,"",a[1],">",null));else if(s.name=="ListItem"&&s.parent.name=="OrderedList"&&(a=/^( *)\d+([.)])( *)/.exec(m.text.slice(o)))){let f=a[3],l=a[0].length;f.length>=4&&(f=f.slice(0,f.length-4),l-=4),e.push(new C(s.parent,o,o+l,a[1],f,a[2],s))}else if(s.name=="ListItem"&&s.parent.name=="BulletList"&&(a=/^( *)([-+*])( {1,4}\[[ xX]\])?( +)/.exec(m.text.slice(o)))){let f=a[4],l=a[0].length;f.length>4&&(f=f.slice(0,f.length-4),l-=4);let d=a[2];a[3]&&(d+=a[3].replace(/[xX]/," ")),e.push(new C(s.parent,o,o+l,a[1],f,d,s))}}return e}function $(t,i){return/^(\s*)(\d+)(?=[.)])/.exec(i.sliceString(t.from,t.from+10))}function B(t,i,r,e=0){for(let n=-1,s=t;;){if(s.name=="ListItem"){let m=$(s,i),o=+m[2];if(n>=0){if(o!=n+1)return;r.push({from:s.from+m[1].length,to:s.from+m[0].length,insert:String(n+2+e)})}n=o}let a=s.nextSibling;if(!a)break;s=a}}function P(t,i){let r=/^[ \t]*/.exec(t)[0].length;if(!r||i.facet(Q)!="	")return t;let e=L(t,4,r),n="";for(let s=e;s>0;)s>=4?(n+="	",s-=4):(n+=" ",s--);return n+t.slice(r)}const ce=({state:t,dispatch:i})=>{let r=b(t),{doc:e}=t,n=null,s=t.changeByRange(a=>{if(!a.empty||!F.isActiveAt(t,a.from))return n={range:a};let m=a.from,o=e.lineAt(m),f=O(r.resolveInner(m,-1),e);for(;f.length&&f[f.length-1].from>m-o.from;)f.pop();if(!f.length)return n={range:a};let l=f[f.length-1];if(l.to-l.spaceAfter.length>m-o.from)return n={range:a};let d=m>=l.to-l.spaceAfter.length&&!/\S/.test(o.text.slice(l.to));if(l.item&&d)if(l.node.firstChild.to>=m||o.from>0&&!/[^\s>]/.test(e.lineAt(o.from-1).text)){let u=f.length>1?f[f.length-2]:null,c,h="";u&&u.item?(c=o.from+u.from,h=u.marker(e,1)):c=o.from+(u?u.to:0);let A=[{from:c,to:m,insert:h}];return l.node.name=="OrderedList"&&B(l.item,e,A,-2),u&&u.node.name=="OrderedList"&&B(u.item,e,A),{range:k.cursor(c+h.length),changes:A}}else{let u="";for(let c=0,h=f.length-2;c<=h;c++)u+=f[c].blank(c<h?L(o.text,4,f[c+1].from)-u.length:null,c<h);return u=P(u+t.lineBreak,t),{range:k.cursor(m+u.length),changes:{from:o.from,insert:u}}}if(l.node.name=="Blockquote"&&d&&o.from){let u=e.lineAt(o.from-1),c=/>\s*$/.exec(u.text);if(c&&c.index==l.from){let h=t.changes([{from:u.from+c.index,to:u.to},{from:o.from+l.from,to:o.to}]);return{range:a.map(h),changes:h}}}let p=[];l.node.name=="OrderedList"&&B(l.item,e,p);let g=l.item&&l.item.from<o.from,x="";if(!g||/^[\s\d.)\-+*>]*/.exec(o.text)[0].length>=l.to)for(let u=0,c=f.length-1;u<=c;u++)x+=u==c&&!g?f[u].marker(e,1):f[u].blank(u<c?L(o.text,4,f[u+1].from)-x.length:null);let w=m;for(;w>o.from&&/\s/.test(o.text.charAt(w-o.from-1));)w--;return x=t.lineBreak+P(x,t),p.push({from:w,to:m,insert:x}),{range:k.cursor(w+x.length),changes:p}});return n?!1:(i(t.update(s,{scrollIntoView:!0,userEvent:"input"})),!0)};function E(t){return t.name=="QuoteMark"||t.name=="ListMark"}function de(t,i){let r=t.resolveInner(i,-1),e=i;E(r)&&(e=r.from,r=r.parent);for(let n;n=r.childBefore(e);)if(E(n))e=n.from;else if(n.name=="OrderedList"||n.name=="BulletList")r=n.lastChild,e=r.to;else break;return r}const pe=({state:t,dispatch:i})=>{let r=b(t),e=null,n=t.changeByRange(s=>{let a=s.from,{doc:m}=t;if(s.empty&&F.isActiveAt(t,s.from)){let o=m.lineAt(a),f=O(de(r,a),m);if(f.length){let l=f[f.length-1],d=l.to-l.spaceAfter.length+(l.spaceAfter?1:0);if(a-o.from>d&&!/\S/.test(o.text.slice(d,a-o.from)))return{range:k.cursor(o.from+d),changes:{from:o.from+d,to:a}};if(a-o.from==d&&(!l.item||o.from<=l.item.from||!/\S/.test(o.text.slice(0,l.to)))){let p=o.from+l.from;if(l.item&&l.node.from<l.item.from&&/\S/.test(o.text.slice(l.from,l.to))){let g=l.blank(L(o.text,4,l.to)-L(o.text,4,l.from));return p==o.from&&(g=P(g,t)),{range:k.cursor(p+g.length),changes:{from:p,to:o.from+l.to,insert:g}}}if(p<a)return{range:k.cursor(p),changes:{from:p,to:a}}}}}return e={range:s}});return e?!1:(i(t.update(n,{scrollIntoView:!0,userEvent:"delete"})),!0)},he=[{key:"Enter",run:ce},{key:"Backspace",run:pe}],v=U({matchClosingTags:!1});function be(t={}){let{codeLanguages:i,defaultCodeLanguage:r,addKeymap:e=!0,base:{parser:n}=fe,completeHTMLTags:s=!0}=t;if(!(n instanceof X))throw new RangeError("Base parser provided to `markdown` should be a Markdown parser");let a=t.extensions?[t.extensions]:[],m=[v.support],o;r instanceof M?(m.push(r.support),o=r.language):r&&(o=r);let f=i||o?ue(i,o):void 0;a.push(j({codeParser:f,htmlParser:v.language.parser})),e&&m.push(G.high(H.of(he)));let l=I(n.configure(a));return s&&m.push(l.data.of({autocomplete:ge})),new M(l,m)}function ge(t){let{state:i,pos:r}=t,e=/<[:\-\.\w\u00b7-\uffff]*$/.exec(i.sliceDoc(r-25,r));if(!e)return null;let n=b(i).resolveInner(r,-1);for(;n&&!n.type.isTop;){if(n.name=="CodeBlock"||n.name=="FencedCode"||n.name=="ProcessingInstructionBlock"||n.name=="CommentBlock"||n.name=="Link"||n.name=="Image")return null;n=n.parent}return{from:r-e[0].length,to:r,options:xe(),validFor:/^<[:\-\.\w\u00b7-\uffff]*$/}}let S=null;function xe(){if(S)return S;let t=z(new K(R.create({extensions:v}),0,!0));return S=t?t.options:[]}export{fe as commonmarkLanguage,pe as deleteMarkupBackward,ce as insertNewlineContinueMarkup,be as markdown,he as markdownKeymap,F as markdownLanguage};
